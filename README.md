# CulturalAssistant
ИИ-ассистент, предназначенный для рекомендации товаров, соответствующих интересам пользователя.

## Содержание

*   [Описание](#описание)
*   [Архитектура](#архитектура)
*   [Пример диалога](#пример-диалога)

## Описание

*   **Суть проекта:** Ассистент представляет из себя Telegram бота, помогающего с выбором товаров для хобби. Пользователи обращаются с некоторой потребностью в их хобби, а в это время ассистент пытается задать наводящие вопросы для уточнения их интересов. Когда бот задал достаточно вопросов, он начинает предлагать релевантные товары из заранее подготовленной базы данных.
*   **Цель проекта:** Помочь пользователям выбрать необходимые товары для их хобби в удобном формате (общение с ассистентом). 
*   **Стандартный процесс работы:** Взаимодействие с ботом начинается с обращения к нему в чате Telegram. Такое обращение может представлять из себя вопрос насчёт хобби, просьба в рекомендации, поиск конкретного товара и подобные. После этого ассистент пытается найти товары в базе данных по запросу. Проанализировав товары, он может либо задать дополнительные наводящие вопросы для уточнения, либо вывести подходящие товары. Бот не задаст слишком много вопросов, чтобы не нагружать пользователя, и будет общаться вежливо и непринуждённо. При этом он будет помнить контекст и стараться держаться в нём. Порекомендовав товар, бот обязательно выдаст ссылку на него, а также предоставит краткое описание.
  
## Архитектура

Внутренне сервис устроен как Telegram бот, использующий LLM модель с открытым исходным кодом для генерации ответов и RAG для нахождения релевантных записей о товарах в наличии.

Работа сервиса начинается с обращения к нему в чате Telegram. Для взаимодействия ассистента и площадки используется библиотека [python-telegram-bot](https://docs.python-telegram-bot.org/en/stable/index.html). 

Все запросы пользователя обрабатываются и хранятся с целью сохранения контекста для модели. Применяется SQLite и стандартная библиотека sqlite3 для работы с ней.

После получения сервисом запроса пользователя сервис достаёт из базы данных историю диалога с этим пользователем и историю товаров, которые ассистент рассматривал как возможные для выдачи. Этот набор данных векторизуется с помощью модели [BAAI/bge-m3](https://huggingface.co/BAAI/bge-m3) и сравнивается с векторами в хранилище [FAISS](https://python.langchain.com/docs/integrations/vectorstores/faiss/). Там лежат описания товаров, которые есть в наличии, названия которых векторизованы той же моделью. Топ 5 самых релевантных товаров добавляются к набору.

Для работы с FAISS, а также векторизации используется [Langchain](https://python.langchain.com/docs/integrations/vectorstores/faiss/). 

Все товары были взяты [отсюда](https://www.sima-land.ru/), ссылки на них ведут туда же.

Далее начинает работу LLM модель [IlyaGusev/saiga_yandexgpt_8b](https://huggingface.co/IlyaGusev/saiga_yandexgpt_8b) (8-битовая квантизованная версия). Модель была выбрана по двум причинам. Во-первых, модель даёт достаточно качественные результаты при работе с текстами на русском языке: [сравнение](https://ilyagusev.github.io/ping_pong_bench/results/v2/ru/saiga_yandexgpt_8b) и [лидерборд](https://ilyagusev.github.io/ping_pong_bench/ru_v2). Во-вторых, модель оптимальна с точки зрения доступных ресурсов. В распоряжении была только версия Google Colab с видеокартой T4.

LLM анализирует полученную информацию, выбирает 10 последних предложенных товаров из RAG и принимает решение: уточняет запрос пользователя, задавая дополнительные вопросы, или отправляет товары, которые удовлетворяют запросу. Режим работы определяется [промптом](configs/system_prompt.txt).

Для работы с моделью используется [transformers](https://huggingface.co/docs/transformers/main/en/index), для квантизации [bitsandbytes](https://github.com/bitsandbytes-foundation/bitsandbytes), вспомогательно [torch](https://pytorch.org/).

В проекте также применяются [Requests](https://pypi.org/project/requests/), [beautifulsoup4](https://pypi.org/project/beautifulsoup4/) и [tqdm](https://tqdm.github.io/) для работы парсера, [Pandas](https://pandas.pydata.org/) для работы с таблицей товаров, [typing](https://docs.python.org/3/library/typing.html) для документирования.

## Пример диалога

Здесь подробно рассмотрен пример общения с ботом. Ещё несколько примеров можно найти в [файлах](test-example/test.ipynb).

Тест проходил в следующем формате:

1. Случайным образом из базы данных был выбран товар: Бусины для творчества "Смайлики на кубике".
2. Далее gpt4-o сгенерировала потребность, которую этот товар закрывает, и отправила как начальный запрос к ассистенту. Таким образом имитировалось обращение пользователя к боту с некоторым запросом, но без найденного решения.
3. После этого бот задавал необходимые вопросы, чтобы порекомендовать лучший товар, а gpt4-o на эти вопросы честно отвечала, имея информацию о товаре.
4. В ходе теста бот должен был сам предложить товар по ответам на вопросы.

Конкретно сейчас, возможно, ссылки не являются рабочими, так как парсинг товаров не динамический.

Диалог:

> **User:** /start
>
> **Bot:** Привет, я ИИ ассистент, помогающий в выборе предметов для хобби. Напиши, какая область тебя интересует, и я подберу что-нибудь специально для тебя. Чтобы очистить контекст и начать выбор нового товара, пиши команду /clear_context.
>
> **User:** Я хочу создать смешной браслет для своей подруги
> 
> **Bot:** Какие цвета любит ваша подруга? Какой стиль браслета она предпочитает – классический, современный, романтический или яркий детский?
>
> **User:** Яркий детский, любит белый цвет
>
> **Bot:** Какие элементы вы хотите добавить к браслету, например, сердечки, звёздочки или забавные фигурки животных? Также интересует размер запястья вашей подруги, чтобы подобрать оптимальную длину браслета.
>
> **User:** Я не знаю размер запястья подруги, нужен универсальный размер. Хотелось бы добавить к браслету что-нибудь смешное
>
> **Bot:** Какие смешные элементы можно использовать при создании детского браслета? Например, фигурки любимых героев мультфильмов, яркие звёзды, улыбающиеся мордочки животных или забавный текст типа "Я люблю обниматься" или "Самая весёлая девочка"?
>
> **User:** Можно попробовать смайлики
>
> **Bot:** Учитывая ваш запрос на создание яркого детского браслета белого цвета со смайликами и универсального размера, мне кажется, что вам подойдут следующие варианты:
>
> Набор для творчества «Создай свой стильный браслет» (универсальный размер)
> Этот набор включает разноцветные бусины и специальные крепления для создания уникального дизайна. Вы сможете легко добавить милые смайлики среди других элементов.
> Ссылка: https://www.sima-land.ru/7450203/ukrasheniya-dlya-devochek-svoimi-rukami-stilnyy-braslet-nabor-busin-dlya-tvorchestva-6-plus-miks/
>
> Украшение для девочек своими руками «Фруктовый браслет» (белый цвет)
> Данный набор подходит идеально под ваши требования: яркие фрукты сочетаются с белым цветом, а также позволят разместить смайлики без проблем.
> Ссылка: https://www.sima-land.ru/9383065/ukrasheniya-dlya-devochek-svoimi-rukami-sozday-braslet-s-sharmami-fruktiki-nabor-busin-dlya-tvorchestva/
>
> Эти два варианта подходят лучше всего благодаря универсальному размеру, яркому дизайну и возможности добавления забавных смайликов
